<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DramTech — Solutions Logicielles Professionnelles</title>
  <meta name="description" content="Plateforme de vente de logiciels premium avec intégration PayPal."/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #7c3aed;
      --dark: #1e293b;
      --darker: #0f172a;
      --light: #f8fafc;
      --gray: #94a3b8;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --radius: 12px;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(to bottom right, #f1f5f9, #e2e8f0);
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--darker);
      color: white;
      padding: 1rem 0;
      box-shadow: var(--shadow);
    }

    footer {
      background: var(--darker);
      color: white;
      text-align: center;
      padding: 1.5rem 0;
      margin-top: auto;
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }

    .row {
      display: flex;
      align-items: center;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 2rem;
      margin: 2rem auto;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .hd {
      background: var(--dark);
      color: white;
      padding: 1rem 1.5rem;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .bd {
      padding: 1.5rem;
    }

    h1 {
      font-size: 1.8rem;
      margin-right: 0.75rem;
    }

    .badge {
      background: var(--primary);
      color: white;
      padding: 0.35rem 0.75rem;
      border-radius: 100px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .muted {
      color: var(--gray);
      font-size: 0.95rem;
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.6rem 1.25rem;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-ghost {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-ghost:hover {
      background: rgba(37, 99, 235, 0.1);
    }

    .btn i {
      font-size: 0.9rem;
    }

    /* Catalogue */
    .catalog {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .item {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 1.25rem;
      padding: 1.5rem;
      border: 1px solid #e2e8f0;
      border-radius: var(--radius);
      transition: var(--transition);
    }

    .item:hover {
      border-color: var(--primary);
    }

    .item img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: var(--radius);
    }

    .meta {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .tag {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
      border-radius: 100px;
      margin-left: 0.5rem;
      font-weight: 600;
    }

    .tag-popular {
      background: #fef3c7;
      color: #92400e;
    }

    .tag-new {
      background: #dbeafe;
      color: #1e40af;
    }

    .tag-ai {
      background: #ede9fe;
      color: #5b21b6;
    }

    .feature-list {
      font-size: 0.9rem;
      color: var(--dark);
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 0.5rem 0;
    }

    .feature-list li {
      background: #f1f5f9;
      padding: 0.35rem 0.75rem;
      border-radius: 100px;
      font-size: 0.8rem;
    }

    .license-type {
      display: flex;
      gap: 0.75rem;
      margin: 0.5rem 0;
    }

    .license-option {
      flex: 1;
      padding: 0.75rem;
      border: 2px solid #e2e8f0;
      border-radius: var(--radius);
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .license-option:hover {
      border-color: var(--primary);
    }

    .license-option.selected {
      border-color: var(--primary);
      background: rgba(37, 99, 235, 0.05);
    }

    .license-option .price {
      font-weight: 700;
      margin-top: 0.25rem;
      color: var(--primary);
    }

    .license-basic .price {
      color: #64748b;
    }

    .license-pro .price {
      color: var(--primary);
    }

    .license-enterprise .price {
      color: #7c3aed;
    }

    /* Panier */
    .cart-line {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 1rem;
      padding: 1rem 0;
      border-bottom: 1px solid #e2e8f0;
      align-items: center;
    }

    .cart-line:last-child {
      border-bottom: none;
    }

    .qty {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .qty button {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .totals {
      margin: 1.5rem 0;
    }

    .totals .row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px dashed #e2e8f0;
    }

    .totals .row:last-child {
      border-bottom: none;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
      margin-top: 0.5rem;
      padding-top: 0.75rem;
    }

    .notice {
      background: #f8fafc;
      padding: 1rem;
      border-radius: var(--radius);
      border-left: 4px solid var(--primary);
    }

    .form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
    }

    .form .full {
      grid-column: 1 / -1;
    }

    .form label {
      display: block;
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.35rem;
      color: var(--dark);
    }

    .form input, .form select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #cbd5e1;
      border-radius: var(--radius);
      font-family: inherit;
      transition: var(--transition);
    }

    .form input:focus, .form select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    /* États de paiement */
    #paypal-status {
      font-weight: 600;
      padding: 0.5rem;
      border-radius: var(--radius);
      text-align: center;
      margin-bottom: 0.5rem;
    }

    #paypal-status.ok {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    #paypal-status.err {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    /* Animation de chargement */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(37, 99, 235, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      padding: 12px 20px;
      border-radius: var(--radius);
      color: white;
      font-weight: 500;
      box-shadow: var(--shadow);
      animation: slideIn 0.3s ease-out;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.warning {
      background: var(--warning);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Responsive adjustments */
    @media (max-width: 640px) {
      .item {
        grid-template-columns: 1fr;
      }
      
      .item img {
        height: 200px;
      }
      
      .license-type {
        flex-direction: column;
      }
      
      .cart-line {
        grid-template-columns: 1fr;
        text-align: center;
        gap: 0.5rem;
      }
      
      .form {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between;flex-wrap:wrap;gap:1rem">
      <div class="row">
        <h1><i class="fas fa-laptop-code"></i> DramTech</h1>
        <span class="badge">Solutions Logicielles</span>
      </div>
      <div class="row" style="gap:12px">
        <span class="muted">Solutions professionnelles avec paiement sécurisé PayPal</span>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <section class="card">
      <div class="hd">Catalogue de Logiciels</div>
      <div class="bd">
        <div class="catalog" id="catalog"></div>
      </div>
    </section>

    <aside class="card">
      <div class="hd row" style="justify-content:space-between">
        <span><i class="fas fa-shopping-cart"></i> Votre panier</span>
        <span class="badge" id="cartCount">0 licence</span>
      </div>
      <div class="bd">
        <div id="cart"></div>
        <div class="totals">
          <div class="row"><span>Sous‑total</span><strong id="subtotal">0.00</strong></div>
          <div class="row"><span>Support technique</span>
            <select id="support" style="width:auto" onchange="recalc()">
              <option value="0">Standard (6 mois)</option>
              <option value="49">Premium (12 mois)</option>
              <option value="99">Prioritaire (24 mois)</option>
            </select>
          </div>
          <div class="row"><span>Taxes (5%)</span><strong id="tax">0.00</strong></div>
          <div class="row"><span>Réduction</span><strong id="discount">0.00</strong></div>
          <div class="row" style="font-size:1.15rem"><span>Total</span><strong id="grandTotal">0.00</strong></div>
        </div>

        <div style="margin:14px 0" class="row">
          <input id="coupon" placeholder="Code promo (WELCOME15)" style="flex:1;padding:0.75rem">
          <button class="btn-ghost" onclick="applyCoupon()">Appliquer</button>
        </div>

        <div class="notice" style="margin:8px 0">
          <div id="paypal-status">Paiement sécurisé par PayPal</div>
          <div id="paypal-button-container" style="margin-top:10px"></div>
        </div>

        <details class="card" style="background:#0b1220;border:1px dashed #223047;margin-top:12px">
          <summary class="bd" style="cursor:pointer;padding:1rem"><i class="fas fa-box"></i> Informations de facturation</summary>
          <div class="bd form">
            <div><label>Prénom</label><input id="fn" placeholder="Prénom"></div>
            <div><label>Nom</label><input id="ln" placeholder="Nom"></div>
            <div class="full"><label>Email</label><input id="email" type="email" placeholder="votre@email.com"></div>
            <div><label>Entreprise</label><input id="company" placeholder="Facultatif"></div>
            <div><label>Pays</label>
              <select id="country">
                <option value="FR">France</option>
                <option value="BE">Belgique</option>
                <option value="CH">Suisse</option>
                <option value="CA">Canada</option>
                <option value="TG">Togo</option>
                <option value="SN">Sénégal</option>
                <option value="CI">Côte d'Ivoire</option>
              </select>
            </div>
          </div>
        </details>

      </div>
    </aside>
  </main>

  <footer class="wrap">
    <div>DramTech &copy; 2025 - Solutions logicielles professionnelles | Paiements sécurisés par PayPal</div>
  </footer>

  <div class="toast-container" id="toastContainer"></div>

  <script>
    /* ---------- Données produits ---------- */
    const PRODUCTS = [
      { 
        id:"p1", 
        name:"DramSuite Pro", 
        description: "Suite bureautique complète avec IA intégrée",
        prices: { basic: 10, pro: 34, enterprise: 90 },
        img:"https://images.unsplash.com/photo-1563207153-f403bf289096?q=80&w=1200&auto=format&fit=crop",
        tags: ["tag-popular", "tag-ai"],
        features: ["Traitement de texte intelligent", "Tableurs avancés", "Présentations dynamiques", "IA intégrée", "Cloud intégré"]
      },
      { 
        id:"p2", 
        name:"DataVision Analytics", 
        description: "Outil d'analyse et visualisation de données",
        prices: { basic: 6, pro: 8, enterprise: 99 },
        img:"https://images.unsplash.com/photo-1551288049-bebda4e38f71?q=80&w=1200&auto=format&fit=crop",
        tags: ["tag-new"],
        features: ["Visualisations interactives", "Connecteurs multiples", "Prédictions IA", "Rapports automatisés", "Export multiples"]
      },
      { 
        id:"p3", 
        name:"SecureShield VPN", 
        description: "Solution de sécurité et VPN d'entreprise",
        prices: { basic: 7, pro: 22, enterprise: 9 },
        img:"https://images.unsplash.com/photo-1563013544-824ae1b704d3?q=80&w=1200&auto=format&fit=crop",
        tags: ["tag-popular"],
        features: ["Chiffrement militaire", "Serveurs mondiaux", "Protection contre les fuites", "Multi-appareils", "Support 24/7"]
      },
      { 
        id:"p4", 
        name:"DesignMaster", 
        description: "Suite de création graphique professionnelle",
        prices: { basic: 24, pro: 44, enterprise: 84 },
        img:"https://images.unsplash.com/photo-1561070791-2526d30994b5?q=80&w=1200&auto=format&fit=crop",
        tags: [],
        features: ["Édition photo avancée", "Vectoriel", "Maquettes UI/UX", "3D basic", "Export professionnel"]
      },
      { 
        id:"p5", 
        name:"CodeFlow Studio", 
        description: "Environnement de développement intelligent",
        prices: { basic: 8, pro: 10, enterprise: 15 },
        img:"https://images.unsplash.com/photo-1611224923853-80b023f02d71?q=80&w=1200&auto=format&fit=crop",
        tags: ["tag-new", "tag-ai"],
        features: ["Multi-languages", "Débogage avancé", "IA d'assistance", "Gestion de projets", "Intégrations"]
      }
    ];

    /* ---------- État global ---------- */
    const state = {
      cart: JSON.parse(localStorage.getItem('cart')||'{}'),
      currency: 'EUR',
      clientId: 'AYCAZd2X6vYmz_sjtKcDRWdYipvNq4_A616TKTTw7-zWKMl0mVf3b0obZhNWxJlVsCHSUY5jDCN1XJ2T',
      sdkLoaded: false,
      buttons: null,
      coupon: null,
      orderData: null
    };

    /* ---------- Utilitaires ---------- */
    const fmt = (n) => new Intl.NumberFormat('fr-FR',{style:'currency', currency: state.currency}).format(Number(n||0));
    const money = (n) => Number(n).toFixed(2);
    
    const itemsFromCart = () => {
      return Object.entries(state.cart)
        .filter(([key]) => !key.endsWith('_type'))
        .map(([id, qty]) => {
          const product = PRODUCTS.find(p => p.id === id);
          const licenseType = state.cart[`${id}_type`] || 'pro';
          const price = product ? product.prices[licenseType] : 0;
          return {...product, qty, licenseType, price};
        });
    };
    
    const subtotalValue = () => itemsFromCart().reduce((s, it) => s + it.price * it.qty, 0);
    const supportValue = () => Number(document.getElementById('support').value || 0);
    const taxValue = () => subtotalValue() * 0.05;
    const discountValue = () => state.coupon === 'WELCOME15' ? Math.min(50, subtotalValue() * 0.15) : 0;
    const grandTotalValue = () => Math.max(0, subtotalValue() + supportValue() + taxValue() - discountValue());

    function persist(){ localStorage.setItem('cart', JSON.stringify(state.cart)); }

    // Fonction pour afficher les notifications toast
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
        ${message}
      `;
      
      document.getElementById('toastContainer').appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    /* ---------- Rendu catalogue ---------- */
    function renderCatalog(){
      const el = document.getElementById('catalog');
      el.innerHTML = PRODUCTS.map(p => {
        const tagsHTML = p.tags.map(tag => `<span class="tag ${tag}">${tag.replace('tag-', '').toUpperCase()}</span>`).join('');
        const featuresHTML = p.features.map(f => `<li>${f}</li>`).join('');
        
        // Vérifier quel type de licence est sélectionné pour ce produit
        const selectedType = state.cart[`${p.id}_type`] || 'pro';
        
        return `
        <article class="item">
          <img alt="${p.name}" loading="lazy" src="${p.img}"/>
          <div class="meta">
            <div>
              <strong>${p.name}</strong>
              ${tagsHTML}
            </div>
            <div class="muted">${p.description}</div>
            
            <ul class="feature-list">
              ${featuresHTML}
            </ul>
            
            <div class="license-type">
              <div class="license-option license-basic ${selectedType === 'basic' ? 'selected' : ''}" onclick="selectLicense('${p.id}', 'basic')">
                <div>Basique</div>
                <div class="price">${fmt(p.prices.basic)}</div>
              </div>
              <div class="license-option license-pro ${selectedType === 'pro' ? 'selected' : ''}" onclick="selectLicense('${p.id}', 'pro')">
                <div>Pro</div>
                <div class="price">${fmt(p.prices.pro)}</div>
              </div>
              <div class="license-option license-enterprise ${selectedType === 'enterprise' ? 'selected' : ''}" onclick="selectLicense('${p.id}', 'enterprise')">
                <div>Enterprise</div>
                <div class="price">${fmt(p.prices.enterprise)}</div>
              </div>
            </div>
            
            <div class="row" style="margin-top:8px">
              <button class="btn" onclick="addToCart('${p.id}')"><i class="fas fa-cart-plus"></i> Ajouter au panier</button>
            </div>
          </div>
        </article>
      `}).join('');
    }

    function selectLicense(productId, licenseType) {
      // Mettre à jour visuellement la sélection
      const productElement = document.querySelector(`.item [onclick*="${productId}"]`).closest('.item');
      const options = productElement.querySelectorAll('.license-option');
      options.forEach(opt => opt.classList.remove('selected'));
      productElement.querySelector(`.license-option[onclick*="${productId}', '${licenseType}')"]`).classList.add('selected');
      
      // Stocker le type de licence sélectionné
      state.cart[`${productId}_type`] = licenseType;
      persist();
      
      // Si le produit est déjà dans le panier, mettre à jour le prix
      if (state.cart[productId]) {
        renderCart();
        showToast('Type de licence mis à jour', 'success');
      }
    }

    /* ---------- Rendu panier ---------- */
    function renderCart(){
      const el = document.getElementById('cart');
      const items = itemsFromCart();
      const count = items.reduce((s,i)=>s+i.qty,0);
      document.getElementById('cartCount').textContent = count + (count>1?' licences':' licence');
      
      if(items.length===0){
        el.innerHTML = '<div class="muted" style="text-align:center;padding:2rem"><i class="fas fa-shopping-cart" style="font-size:2rem;margin-bottom:1rem;opacity:0.5"></i><br>Votre panier est vide.</div>';
      } else {
        el.innerHTML = items.map(it => `
          <div class="cart-line">
            <div>
              <strong>${it.name}</strong>
              <div class="muted">${it.licenseType.toUpperCase()} - ${fmt(it.price)} × ${it.qty}</div>
            </div>
            <div style="text-align:right;font-weight:600">${fmt(it.price*it.qty)}</div>
            <div style="text-align:right" class="qty">
              <button class="btn-ghost" onclick="dec('${it.id}')">−</button>
              <span style="min-width:2rem;text-align:center">${it.qty}</span>
              <button class="btn" onclick="inc('${it.id}')">+</button>
            </div>
          </div>
        `).join('');
      }
      recalc();
    }

    function recalc(){
      document.getElementById('subtotal').textContent = fmt(subtotalValue());
      document.getElementById('tax').textContent = fmt(taxValue());
      document.getElementById('discount').textContent = '− ' + fmt(discountValue());
      document.getElementById('grandTotal').textContent = fmt(grandTotalValue());
      
      // Mettre à jour le bouton PayPal si le SDK est chargé
      if(state.sdkLoaded && window.paypal && state.buttons){
        try {
          if(subtotalValue() <= 0){
            state.buttons.close();
            document.getElementById('paypal-button-container').innerHTML = '';
            setStatus('Ajoutez des produits pour payer', false);
          } else {
            renderPayPalButtons();
          }
        } catch(e) {
          console.error("Erreur de mise à jour des boutons PayPal:", e);
        }
      }
    }

    function addToCart(id, qty=1){ 
      // Récupérer le type de licence sélectionné
      const licenseType = state.cart[`${id}_type`] || 'pro';
      state.cart[`${id}_type`] = licenseType;
      state.cart[id] = (state.cart[id]||0) + qty; 
      persist(); 
      renderCart();
      
      const product = PRODUCTS.find(p => p.id === id);
      showToast(`${product.name} ajouté au panier`, 'success');
    }
    
    function inc(id){ 
      addToCart(id,1); 
    }
    
    function dec(id){ 
      if(!state.cart[id]) return; 
      state.cart[id]-=1; 
      if(state.cart[id]<=0) delete state.cart[id]; 
      persist(); 
      renderCart(); 
      
      const product = PRODUCTS.find(p => p.id === id);
      if (product) {
        showToast(`${product.name} retiré du panier`, 'warning');
      }
    }

    function applyCoupon(){
      const code = (document.getElementById('coupon').value||'').trim().toUpperCase();
      const oldCoupon = state.coupon;
      state.coupon = code === 'WELCOME15' ? code : null;
      
      if (state.coupon && !oldCoupon) {
        showToast('Code promo appliqué avec succès!', 'success');
      } else if (!state.coupon && oldCoupon) {
        showToast('Code promo retiré', 'warning');
      } else if (code && !state.coupon) {
        showToast('Code promo invalide', 'error');
      }
      
      recalc();
    }

    /* ---------- PayPal ---------- */
    function setStatus(msg, ok){ 
      const s = document.getElementById('paypal-status'); 
      s.textContent = msg; 
      s.className = ok ? 'ok' : 'err'; 
    }

    function loadPayPalSdk(){
      state.sdkLoaded = false;
      if(state.buttons){ try{ state.buttons.close(); }catch(e){} state.buttons=null; }
      document.getElementById('paypal-button-container').innerHTML = '';
      const old = document.getElementById('paypal-sdk');
      if(old) old.remove();
      setStatus('Chargement du système de paiement...', true);
      const src = `https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(state.clientId)}&currency=${encodeURIComponent(state.currency)}&components=buttons`;
      const s = document.createElement('script');
      s.id = 'paypal-sdk';
      s.src = src;
      s.async = true;
      s.onload = () => { 
        state.sdkLoaded = true; 
        setStatus('Système de paiement prêt ✔︎', true); 
        renderPayPalButtons(); 
      };
      s.onerror = () => { 
        setStatus('Échec de chargement du système de paiement.', false); 
        showToast('Impossible de charger PayPal. Veuillez réessayer.', 'error');
      };
      document.head.appendChild(s);
    }

    function toPayPalItems(){
      return itemsFromCart().map(it => ({
        name: `${it.name} (${it.licenseType.toUpperCase()})`,
        unit_amount: { value: money(it.price), currency_code: state.currency },
        quantity: String(it.qty)
      }));
    }

    function validateBillingInfo() {
      const fn = document.getElementById('fn').value.trim();
      const ln = document.getElementById('ln').value.trim();
      const email = document.getElementById('email').value.trim();
      
      if (!fn || !ln) {
        showToast('Veuillez saisir votre prénom et nom', 'error');
        return false;
      }
      
      if (!email || !/^\S+@\S+\.\S+$/.test(email)) {
        showToast('Veuillez saisir une adresse email valide', 'error');
        return false;
      }
      
      return true;
    }

    function renderPayPalButtons(){
      if(!window.paypal){ 
        setStatus('Système de paiement indisponible.', false); 
        return; 
      }
      
      const container = document.getElementById('paypal-button-container');
      container.innerHTML = '';
      
      if (subtotalValue() <= 0) {
        setStatus('Ajoutez des produits pour payer', false);
        return;
      }
      
      state.buttons = window.paypal.Buttons({
        style: { 
          layout: 'vertical', 
          shape: 'pill', 
          color: 'blue',
          label: 'pay',
          height: 45
        },
        
        onInit: function(data, actions){
          if(subtotalValue() <= 0){ 
            actions.disable(); 
          } else { 
            actions.enable(); 
          }
        },
        
        onClick: function() {
          // Valider les informations de facturation avant le paiement
          if (!validateBillingInfo()) {
            return false;
          }
        },
        
        createOrder: function(data, actions){
          const total = money(grandTotalValue());
          if(parseFloat(total) <= 0){ 
            showToast('Ajoutez des licences au panier.', 'error'); 
            return; 
          }
          
          const breakdown = {
            item_total: { value: money(subtotalValue()), currency_code: state.currency },
            handling:   { value: money(supportValue()), currency_code: state.currency },
            tax_total:  { value: money(taxValue()), currency_code: state.currency },
            discount: { value: money(discountValue()), currency_code: state.currency }
          };
          
          return actions.order.create({
            application_context: {
              shipping_preference: 'NO_SHIPPING',
              user_action: 'PAY_NOW'
            },
            purchase_units: [{
              amount: { 
                currency_code: state.currency, 
                value: total, 
                breakdown 
              },
              items: toPayPalItems(),
              payee: { email_address: "votre-email-business@dramtech.com" },
              description: "Licences logicielles DramTech",
              custom_id: "ORDER_" + Date.now()
            }]
          });
        },
        
        onApprove: function(data, actions){
          setStatus('Traitement du paiement... <span class="loading"></span>', true);
          
          return actions.order.capture().then(function(details){
            setStatus('Paiement réussi! ✔︎', true);
            
            // Réinitialiser le panier après paiement réussi
            state.cart = {};
            state.coupon = null;
            persist();
            renderCart();
            document.getElementById('coupon').value = '';
            
            // Afficher le récapitulatif de la commande
            showToast(`Paiement confirmé! Merci ${details.payer.name.given_name}.`, 'success');
            
            console.log('Transaction complète:', details);
          }).catch(function(err){
            setStatus('Erreur lors du traitement du paiement.', false);
            showToast('Erreur lors du traitement du paiement.', 'error');
            console.error('Erreur PayPal:', err);
          });
        },
        
        onCancel: function(data){
          setStatus('Paiement annulé.', false);
          showToast('Paiement annulé', 'warning');
        },
        
        onError: function(err){
          setStatus('Erreur système.', false);
          showToast('Erreur système lors du paiement', 'error');
          console.error('Erreur PayPal:', err);
        }
      });
      
      state.buttons.render('#paypal-button-container').catch(function(err){
        console.error('Erreur de rendu des boutons PayPal:', err);
        setStatus('Impossible d\'initialiser le paiement.', false);
      });
    }

    /* ---------- Initialisation ---------- */
    function init(){
      renderCatalog();
      renderCart();
      loadPayPalSdk();
      
      // Vérifier si un code promo est déjà dans l'URL
      const urlParams = new URLSearchParams(window.location.search);
      const couponCode = urlParams.get('coupon');
      if (couponCode) {
        document.getElementById('coupon').value = couponCode;
        applyCoupon();
      }
    }

    // Initialiser l'application au chargement
    window.onload = init;
  </script>
</body>
</html>